<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSO 531 In Class Chat</title>
    <style>
        /* --- MAC OS 90s AESTHETIC --- */
        :root {
            --mac-bg: #ddd; /* Desktop pattern color */
            --window-bg: #fff;
            --border: #000;
            --highlight: #000; /* Selected text */
            --font-stack: "Geneva", "Verdana", sans-serif;
        }

        body {
            background-color: var(--mac-bg);
            /* Dotted desktop pattern */
            background-image: radial-gradient(#888 15%, transparent 16%), radial-gradient(#888 15%, transparent 16%);
            background-size: 4px 4px;
            background-position: 0 0, 2px 2px;
            font-family: var(--font-stack);
            margin: 0;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* Window Frame */
        .mac-window {
            width: 900px;
            height: 650px;
            background: var(--window-bg);
            border: 1px solid var(--border);
            box-shadow: 4px 4px 0px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Title Bar */
        .title-bar {
            height: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            background: repeating-linear-gradient(
                180deg,
                #fff,
                #fff 1px,
                #ccc 1px,
                #ccc 2px
            );
            position: relative;
            cursor: default;
            user-select: none;
        }

        .close-box {
            width: 14px;
            height: 14px;
            border: 1px solid var(--border);
            background: #fff;
            position: absolute;
            left: 8px;
            top: 4px;
            box-shadow: 1px 1px 0 #000;
        }

        .window-title {
            background: #fff;
            padding: 0 10px;
            font-size: 13px;
            font-weight: bold;
            letter-spacing: 0.5px;
        }

        /* Content Area */
        .content {
            flex: 1;
            padding: 25px;
            display: flex;
            flex-direction: column;
            font-size: 14px;
        }

        /* Screens (Login vs Chat) */
        .screen {
            display: none; /* Hidden by default */
            height: 100%;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }
        .screen.active {
            display: flex;
        }

        /* Logo Styling */
        .retro-logo {
            width: 80px;
            height: 80px;
            border: 2px solid #000;
            image-rendering: pixelated; /* Keeps it sharp/retro */
            box-shadow: 3px 3px 0 #888;
            margin-bottom: 10px;
        }

        /* Chat Specifics */
        #chat-screen {
            justify-content: flex-start;
            align-items: stretch;
        }

        #chat-history {
            flex: 1;
            border: 1px solid var(--border);
            margin-bottom: 15px;
            padding: 10px;
            overflow-y: scroll;
            background: #fff;
            font-family: "Monaco", "Courier New", monospace;
            font-size: 13px;
        }

        .message-line { margin-bottom: 6px; }
        .msg-time { color: #666; margin-right: 8px; font-size: 0.9em; }
        .msg-user { font-weight: bold; }
        .msg-instructor { color: #0000aa; } /* Instructor text color */

        /* Controls */
        .controls-row {
            display: flex;
            gap: 10px;
        }

        input[type="text"], input[type="email"] {
            border: 1px solid var(--border);
            padding: 8px;
            font-family: var(--font-stack);
            font-size: 14px;
            box-shadow: 2px 2px 0 #ccc inset;
        }

        button {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 0;
            padding: 6px 18px;
            font-family: var(--font-stack);
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 2px 2px 0 #000;
        }
        button:active {
            background: #000;
            color: #fff;
            box-shadow: none;
            transform: translate(2px, 2px);
        }

        .hidden { display: none !important; }
        
        h2 { margin: 0 0 10px 0; font-size: 18px; text-align: center; }
        .label-text { width: 80px; display: inline-block; text-align: right; margin-right: 10px; font-weight: bold;}
        .form-row { margin-bottom: 12px; }

        /* Scrollbar styling for Webkit */
        ::-webkit-scrollbar { width: 16px; }
        ::-webkit-scrollbar-track { background: #fff; border-left: 1px solid #000; }
        ::-webkit-scrollbar-thumb { background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAAIklEQVQIW2NkQAKrVq36zwjjgzhhYWGMYAEYB8RmROaABADeOQ8CXl/xfgAAAABJRU5ErkJggg=='); border: 1px solid #000; box-shadow: inset 1px 1px 0 #fff; }
    </style>
</head>
<body>

<div class="mac-window">
    <div class="title-bar">
        <div class="close-box"></div>
        <div class="window-title">DSO 531 In Class Chat</div>
    </div>
    
    <div class="content">
        
        <!-- SCREEN 1: ROLE SELECTION -->
        <div id="role-screen" class="screen active">
            <img src="https://avatars.githubusercontent.com/u/256480427?s=200&v=4" alt="Logo" class="retro-logo">
            
            <h2>DSO 531 In Class Chat</h2>
            <p>Please select your role:</p>
            <div style="display: flex; gap: 20px;">
                <button onclick="selectRole('instructor')">Instructor</button>
                <button onclick="selectRole('student')">Student</button>
            </div>
        </div>

        <!-- SCREEN 2: INSTRUCTOR SETUP -->
        <div id="instructor-setup-screen" class="screen">
            <h2>Instructor Station</h2>
            
            <!-- ADDED: Instructor Email Input -->
            <div class="form-row">
                <span class="label-text">Email:</span>
                <input type="email" id="inst-email" placeholder="prof@usc.edu">
            </div>

            <p>Your Session Code is:</p>
            <h1 id="generated-code" style="font-family: 'Monaco'; font-size: 48px; letter-spacing: 5px; border: 2px dashed #000; padding: 10px 20px;">...</h1>
            <p>Share this code with your students.</p>
            <button onclick="startInstructorSession()">Open Chat Window</button>
        </div>

        <!-- SCREEN 3: STUDENT LOGIN -->
        <div id="student-login-screen" class="screen">
            <h2>Student Login</h2>
            <div class="form-row">
                <span class="label-text">Name:</span>
                <input type="text" id="stu-name" placeholder="John Doe">
            </div>
            <div class="form-row">
                <span class="label-text">Email:</span>
                <input type="email" id="stu-email" placeholder="john@usc.edu">
            </div>
            <div class="form-row">
                <span class="label-text">Code:</span>
                <input type="text" id="stu-code" placeholder="123" maxlength="3" style="width: 60px; text-align: center;">
            </div>
            <button onclick="startStudentSession()">Join Session</button>
        </div>

        <!-- SCREEN 4: CHAT INTERFACE -->
        <div id="chat-screen" class="screen">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px; border-bottom: 1px dotted #000; padding-bottom: 5px;">
                <span id="session-info" style="font-weight: bold;">Session: ???</span>
                <span id="user-info">User: ???</span>
            </div>
            
            <div id="chat-history"></div>
            
            <div class="controls-row">
                <input type="text" id="message-input" style="flex:1;" placeholder="Type a message..." autocomplete="off">
                <button id="send-btn">Send</button>
                <button id="end-btn" class="hidden" style="border-color: #a00; color: #a00;">End & Save</button>
            </div>
        </div>

    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    
    // State
    let currentUser = { name: "", email: "", role: "", room: "" };
    let chatLog = [];

    // DOM Elements
    const screens = {
        role: document.getElementById('role-screen'),
        instructor: document.getElementById('instructor-setup-screen'),
        student: document.getElementById('student-login-screen'),
        chat: document.getElementById('chat-screen')
    };
    
    const chatHistoryDiv = document.getElementById('chat-history');
    const msgInput = document.getElementById('message-input');
    const endBtn = document.getElementById('end-btn');

    // --- NAVIGATION ---
    function showScreen(name) {
        Object.values(screens).forEach(s => s.classList.remove('active'));
        screens[name].classList.add('active');
    }

    function selectRole(role) {
        currentUser.role = role;
        if (role === 'instructor') {
            // Generate random 3 digit code (100 - 999)
            const code = Math.floor(100 + Math.random() * 900).toString();
            currentUser.room = code;
            currentUser.name = "Instructor";
            document.getElementById('generated-code').innerText = code;
            showScreen('instructor');
        } else {
            showScreen('student');
        }
    }

    // --- SESSION START ---
    function startInstructorSession() {
        // Validate Email
        const emailInput = document.getElementById('inst-email');
        const email = emailInput.value.trim();
        
        if(!email) {
            alert("Please enter your email address.");
            return;
        }
        
        currentUser.email = email;
        joinChatRoom();
        // Show End Button for Instructor
        endBtn.classList.remove('hidden');
    }

    function startStudentSession() {
        const name = document.getElementById('stu-name').value.trim();
        const email = document.getElementById('stu-email').value.trim();
        const code = document.getElementById('stu-code').value.trim();

        if(!name || !email || !code) {
            alert("Please fill in all fields.");
            return;
        }

        currentUser.name = name;
        currentUser.email = email;
        currentUser.room = code;

        joinChatRoom();
    }

    function joinChatRoom() {
        // Update UI Info
        document.getElementById('session-info').innerText = `Session: ${currentUser.room}`;
        document.getElementById('user-info').innerText = `User: ${currentUser.name}`;
        
        // Connect via Socket
        socket.emit('join room', currentUser.room);
        
        showScreen('chat');
        addSystemMessage(`Joined session ${currentUser.room} as ${currentUser.role}.`);
    }

    // --- CHAT LOGIC ---
    document.getElementById('send-btn').addEventListener('click', sendMessage);
    msgInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });

    function sendMessage() {
        const text = msgInput.value.trim();
        if(!text) return;

        const payload = {
            room: currentUser.room,
            user: currentUser.name,
            email: currentUser.email, // ADDED: Send email with message
            role: currentUser.role,
            text: text,
            timestamp: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
        };

        socket.emit('chat message', payload);
        msgInput.value = '';
        msgInput.focus();
    }

    // Receive Message
    socket.on('chat message', (msg) => {
        const div = document.createElement('div');
        div.className = 'message-line';
        
        // Style instructor differently
        const userClass = msg.role === 'instructor' ? 'msg-user msg-instructor' : 'msg-user';
        
        div.innerHTML = `<span class="msg-time">[${msg.timestamp}]</span><span class="${userClass}">${escapeHtml(msg.user)}:</span> <span>${escapeHtml(msg.text)}</span>`;
        
        chatHistoryDiv.appendChild(div);
        chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;

        // ADDED: Save to local log with Name, Email, Comment format
        // Format: [Timestamp] Name | Email | Comment
        chatLog.push(`[${msg.timestamp}] ${msg.user} | ${msg.email} | ${msg.text}`);
    });

    // --- END & SAVE (Instructor Only) ---
    endBtn.addEventListener('click', () => {
        if(!confirm("End session and download transcript?")) return;

        // 1. Notify server to end session for everyone
        socket.emit('end session', currentUser.room);

        // 2. Download Log
        downloadLog();
    });

    socket.on('session ended', () => {
        addSystemMessage("--- SESSION ENDED BY INSTRUCTOR ---");
        msgInput.disabled = true;
        document.getElementById('send-btn').disabled = true;
        endBtn.disabled = true;
        
        // If instructor, the download triggers in the click handler. 
        // If student, they just see the message.
    });

    function downloadLog() {
        const content = chatLog.join('\n');
        const blob = new Blob([content], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `DSO531_Chat_${currentUser.room}_${Date.now()}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function addSystemMessage(text) {
        const div = document.createElement('div');
        div.style.color = '#666';
        div.style.fontStyle = 'italic';
        div.innerText = `>> ${text}`;
        chatHistoryDiv.appendChild(div);
    }

    function escapeHtml(text) {
        return text.replace(/[&<>"']/g, function(m) { 
            return {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'}[m]; 
        });
    }
</script>

</body>
</html>
